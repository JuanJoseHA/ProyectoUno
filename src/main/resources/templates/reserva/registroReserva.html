<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>
  Nueva reserva
</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<div th:replace="fragmentos/header :: siteHeader('reserva','registro')"></div>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

	

      <form th:object="${reserva}"
      th:action="${reserva.idservicio} != null ? 
                 @{/reservas/actualizar/{id}(id=${reserva.idservicio})} : 
                 @{/reservas/guardar}"
      method="post" class="row g-3">

        <input type="hidden" th:if="${reserva.idservicio != null}" th:field="*{idservicio}">
    <input type="hidden" th:if="${reserva.idservicio != null}" th:field="*{estatus}">
    <input type="hidden" th:if="${reserva.idservicio != null}" th:field="*{fecha}">
    
    <input type="hidden" th:if="${reserva.cliente != null and reserva.cliente.id != null and #authorization.expression('hasAuthority(''Cliente'')')}" th:field="*{cliente.id}" />

        <div class="row g-3">

          <div class="col-md-6">
            <label class="form-label">Cliente</label>
            <select class="form-select" th:field="*{cliente.id}" required 
                    th:disabled="${reserva.cliente != null and reserva.cliente.id != null and #authorization.expression('hasAuthority(''Cliente'')')}"> <option value="" disabled th:selected="${reserva.cliente == null}">-- Selecciona Cliente --</option>
              <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre + ' ' + c.apellidos}"></option>
            </select>
            <div class="form-text" th:if="${#authorization.expression('hasAuthority(''Cliente'')') and reserva.cliente != null}">
                Como cliente, solo puedes reservar a tu nombre.
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Mesa</label>
            <select class="form-select" th:field="*{mesa.idmesa}" required>
              <option value="" disabled th:selected="${reserva.mesa == null}">-- Selecciona Mesa --</option>
              <option th:each="m : ${mesas}" th:value="${m.idmesa}"
                      th:text="${'Mesa #' + m.idmesa + ' - ' + m.ubicacion + ' (' + m.capacidad + ' pers.)'}"></option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">D√≠a de Reserva</label>
            <input type="date" th:field="*{fecha}" class="form-control" id="fechaInput" required> 
          </div>

          <div class="col-md-6">
            <label class="form-label">Hora</label>
            <input type="time" th:field="*{hora}" class="form-control" step="60" id="horaInput" required>
          </div>

          </div>

        <div class="d-grid gap-2 mt-4">
          <button type="submit" class="btn btn-primary"
                  th:text="${reserva.idservicio} != null ? 'Actualizar Reserva' : 'Registrar Reserva'">Registrar</button>
          <a class="btn btn-secondary" th:href="@{/reservas}">Cancelar</a>
        </div>
      </form>

    </div>
  </div>
</div>

<div th:replace="fragmentos/footer :: siteFooter()"></div>

<script th:inline="javascript">
    // 1. DETERMINAR SI ESTAMOS EDITANDO
    const isEditing = /*[[${reserva.idservicio} != null]]*/ false;
    
    document.addEventListener('DOMContentLoaded', (event) => {
        const fechaInput = document.getElementById('fechaInput');
        const horaInput = document.getElementById('horaInput');
        
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');

        const todayDateString = `${year}-${month}-${day}`;
        // Hora actual + 1 minuto para evitar problemas al abrir el form justo a la hora exacta
        const nowTimeString = `${hour}:${String(now.getMinutes()+1).padStart(2, '0')}`;
        
        // 1. Establecer fecha m√≠nima (solo desde hoy en adelante)
        fechaInput.setAttribute('min', todayDateString);

        // 2. Funci√≥n para establecer hora m√≠nima si la fecha seleccionada es hoy
        function updateMinTime() {
            const selectedDate = fechaInput.value;
            
            if (selectedDate === todayDateString) {
                
                // *** MODIFICACI√ìN CLAVE ***
                if (!isEditing) {
                    // üö® Si es una NUEVA reserva, aplica la restricci√≥n.
                    horaInput.setAttribute('min', nowTimeString);
                } else {
                    // ‚úÖ Si estamos EDITANDO, eliminamos el atributo 'min' del campo hora
                    // para que la hora pasada se pueda actualizar sin error.
                    horaInput.removeAttribute('min');
                }

            } else {
                // Si es una fecha futura, no hay restricci√≥n de hora.
                horaInput.removeAttribute('min');
            }
        }
        
        // Ejecutar la funci√≥n al cargar y al cambiar la fecha
        updateMinTime();
        fechaInput.addEventListener('change', updateMinTime);
    });
</script>
</body>
</html>